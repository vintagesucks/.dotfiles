- defaults:
    link:
      create: true
      relink: true
    brewfile:
      stdout: true
      stderr: false
      include: ['tap', 'brew', 'cask', 'mas', 'vscode']

- clean: ['~']

- brewfile:
    file: Brewfile

- shell:
  - [sudo-touchid]

- if:
    cond: '[ "$(hostname)" = "air" ]'
    met:
    - brewfile:
        file: personal/Brewfile
    unmet:
    - shell:
      -
        command: echo Skipping personal Brewfile
        stdout: true
        quiet: true

- if:
    cond: '[ "$(hostname)" = "albus" ]'
    met:
    - brewfile:
        file: jungehaie/Brewfile
    unmet:
    - shell:
      -
        command: echo Skipping jungehaie Brewfile
        stdout: true
        quiet: true

- shell:
  - command: git config --local filter.machine-settings.clean 'sed -E "/\"editor\.fontSize\"|\"editor\.lineHeight\"|\"terminal\.integrated\.fontSize\"/d"'
    description: "Set up clean filter for machine-specific settings"
  - command: |
      git config --local filter.machine-settings.smudge 'bash -c "
      HOST=\$(hostname)
      if [ \"\$HOST\" = \"air\" ]; then
          sed -E \"s/^{/{\\n  \\\"editor.lineHeight\\\": 29,/\"
      else
          sed -E \"s/^{/{\\n  \\\"editor.fontSize\\\": 14,\\n  \\\"editor.lineHeight\\\": 34,\\n  \\\"terminal.integrated.fontSize\\\": 14,/\"
      fi"'
    description: "Set up smudge filter for machine-specific settings"
  - command: |
      cp vscode/settings.json vscode/settings.json.backup
      bash -c "$(git config --get filter.machine-settings.clean)" < vscode/settings.json > vscode/settings.json.tmp
      bash -c "$(git config --get filter.machine-settings.smudge)" < vscode/settings.json.tmp > vscode/settings.json
      rm -f vscode/settings.json.tmp vscode/settings.json.backup
    description: "Apply machine-specific settings to VS Code settings"

- link:
    ~/.zshrc: zshrc
    '~/Library/Application Support/Code/User/settings.json': vscode/settings.json
    ~/.config/direnv/direnv.toml: direnv.toml

- if:
    cond: 'command -v nix'
    met:
      - shell:
        -
          command: [sudo determinate-nixd upgrade, Upgrading Nix]
          stdout: true
    unmet:
      - shell:
        -
          command: [curl --proto '=https' --tlsv1.2 -sSf -L https://install.determinate.systems/nix | sh -s -- install, Installing Nix]
          stdout: true

- if:
    cond: 'command -v devenv'
    met:
      - shell:
        -
          command: [nix-env --upgrade --attr devenv -f https://github.com/NixOS/nixpkgs/tarball/nixpkgs-unstable, Upgrading devenv]
          stdout: true
    unmet:
      - shell:
        -
          command: [nix-env --install --attr devenv -f https://github.com/NixOS/nixpkgs/tarball/nixpkgs-unstable, Installing devenv]
          stdout: true
